<!DOCTYPE HTML>

<html>
	<head>
		<meta charset="UTF-8">
		<style type = "text/css">
			#gameScreen{
				border-left: 1px solid black;
				background-color : black;
				margin : 300px;
				margin-top : 100px;
			}
			#box{
				display: none;
				position: absolute;
   				background-color: black;
   				color: white;
   				font-family:Sans-Serif;
   				padding: 15px;
    			width: 280px;
    			height: 170px;
    			border: 3px solid white;
    			top: 220px;
    			left: 520px;
			}
		</style>   
	<title>BRICKS</title> 
	</head>
	<body>
		<div id="box">
			<h2> HIGH SCORE!</h2>
			<p>ENTER YOUR NAME:</P>
			<form id="nameform">
				<input  value ="NAME" name='name'></input>
				<button id="ok">OK</button>
			</form>
		</div>
		<canvas id="gameScreen"  height="400" width="700"  onclick="bricks_game.start()">Your Browser does not support Canvas.</canvas>
		
		<script>
		var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                            		window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
  		
  		window.requestAnimationFrame = requestAnimationFrame;
  	
  		var nameForm = document.getElementById("nameform");	
		var nameBox = document.getElementById("box");
		
		var okButton = document.getElementById("ok");
		okButton.addEventListener('click', function(evt){
			bricks_game.postScore();
			evt.preventDefault();
		})
		
						
		var brick_screen = document.getElementById('gameScreen');
		var b_ctx = brick_screen.getContext('2d');
		b_ctx.fillStyle = "white";
		
		SCREEN_WIDTH = brick_screen.width;
		SCREEN_HEIGHT = brick_screen.height;
		var mousex= null;
		
//METHODS FOR THE DIALOG BOX THAT TAKES YOUR HI-SCORE AT THE END OF THE GAME	
		nameBox.show = function(){
			nameBox.style.display = "inline";
		}
		
		nameBox.hide = function(){
			nameBox.style.display = "none";
		}
		
//GAME SET UP AND INTRO CODE
	var getsSent= 0; //temporary global variable for testing;
		var bricks_game = {
			playing : false,
			checkedScores : true,
			score : 0,
			level : 1,
			combo : 1,
			lives : 3,
			boundary: null,
			bricks: null,
			bricksLeft : 0
			
		}
		function getMousePos(e){
			mousex = e.clientX - bricks_game.boundary.left;			
		}
		
		bricks_game.welcomeScreen = function(){
			b_ctx.clearRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
			b_ctx.fillStyle = 'white';
			b_ctx.font = "120px Andale Mono";
			b_ctx.fillText('BRICKS', 150,200);
			b_ctx.font = "14px Sans-Serif";
			b_ctx.fillText('click to play', 315,220);
			setTimeout(function(){
				if(!bricks_game.playing){
					bricks_game.getScores();
				}
			}, 5000);
		}
				
		bricks_game.showScores = function(scores){
			console.log(scores);
			var xoffset = 100;
			var yoffset = 100;
			b_ctx.clearRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
			b_ctx.fillStyle = 'white';
			b_ctx.fillText("HI SCORES", 315 ,50);
			for(var entry in scores){
				b_ctx.font = "14px Sans-Serif";
				if(entry < 10){
					b_ctx.fillText('      ' + scores[entry].name , xoffset + 100, yoffset);
					b_ctx.fillText('      '+ scores[entry].score, xoffset * 3.5, yoffset);
					yoffset += 20;
				}
			}
			setTimeout(function(){
				if(!bricks_game.playing){
					bricks_game.welcomeScreen();
				}
			}, 5000);
		}
		
		bricks_game.getName = function(){
			nameBox.show();
		}
		
		bricks_game.checkScore = function(scores){
			if(scores[scores.length-1].score < bricks_game.score||
			scores.length < 15){
				bricks_game.getName();
			}
		}
		
// CODE THAT COMMUNICATES WITH THE SERVER			
		
		bricks_game.getScores = function(){
			var scores;
			var scoresRequest = new XMLHttpRequest();
			scoresRequest.onreadystatechange = function(){
				if(scoresRequest.readyState === 4){
					if(scoresRequest.status === 200 || scoresRequest.status === 304){
						scores = JSON.parse(scoresRequest.responseText);
						if(bricks_game.checkedScores){ //hacky way to make sure we aren't checking to see if we have a high score
							bricks_game.showScores(scores);
						}
						else{
							bricks_game.checkScore(scores);
							bricks_game.checkedScores = true;
						}
					}
				}		
			}
			scoresRequest.open("GET", "/scores", true);
			scoresRequest.send();
		}
		
		bricks_game.postScore = function(){
			var scoreSend = new XMLHttpRequest();
			scoreSend.onreadystatechange = function(){
				if(scoreSend.readyState === 4){
					nameBox.hide();
					bricks_game.welcomeScreen();
				}		
			}
			var name = nameForm[0].value;
			if(name.length > 10){
				name= name.substring(0, 10);
			}
			var params = "name="+String(name) + "&score="+ String(bricks_game.score);
			
			scoreSend.open("POST", "/", true);
			scoreSend.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			scoreSend.setRequestHeader("Content-length", params.length);
			scoreSend.setRequestHeader("Connection", "close")
			scoreSend.send(params);
			return false;
		}

//GAME LOOP CODE
		
		bricks_game.start = function(){
				if(!bricks_game.playing){			
					bricks_game.playing = true;
					bricks_game.checkedScores = false;
					if(bricks_game.lives == 0){
						bricks_game.lives = 3;
						bricks_game.score = 0;
					}
					window.addEventListener("mousemove", getMousePos,false);
					brick_screen.setAttribute("style", "cursor:none;");
					this.boundary = brick_screen.getBoundingClientRect();
					if(bricks_game.lives ==3){					
						this.bricks = create_bricks();	
					}				
					this.update();	
				}
			}
		
		bricks_game.update = function(){
			b_ctx.clearRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT);
			ball.update();
			paddle.update();
			check_bricks(bricks_game.bricks);
			paddle.draw();
			ball.draw();
			draw_bricks(bricks_game.bricks);
			bricks_game.writeText();
			if(bricks_game.bricksLeft == 0){			
				bricks_game.nextLevel();
			}
			if(bricks_game.playing){
				window.requestAnimationFrame(bricks_game.update);
			}
		}
		
		bricks_game.nextLevel = function(){
			if(ball.y >= 250 || ball.y < 60){ 
				bricks_game.level++;
				if(ball.dy < 0){
					ball.dy--;
				}
				if(ball.dy >0){
					ball.dy++;
				}
				for(var brick = 0; brick <bricks_game.bricks.length; brick++){
					if(!bricks_game.bricks[brick].alive){
						bricks_game.bricks[brick].alive = true;
						bricks_game.bricksLeft++;
					}
				}
			}
		}
		
		bricks_game.writeText = function(){
			b_ctx.fillStyle = 'white';
			b_ctx.font = "14px Sans-Serif";
			b_ctx.fillText('COMBO: ' + bricks_game.combo + '  SCORE: '+ bricks_game.score, 450,20);
			b_ctx.fillText('LEVEL: ' + bricks_game.level + '  LIVES: ' + bricks_game.lives,10,20);
		}
		
		bricks_game.death = function(){
			bricks_game.playing = false;
			ball.x = 0;
			ball.y = 250;
			ball.dx = 2;
			ball.dy = 2 + bricks_game.level - 1;
			bricks_game.combo = 1;
			bricks_game.lives--;
			if(bricks_game.lives == 0){		
				brick_screen.style.cursor  = "";
				b_ctx.clearRect(0,0,700,50);
				bricks_game.writeText();
				b_ctx.fillStyle = 'white';
				b_ctx.font = "30px Sans-Serif";
				b_ctx.fillText("GAME OVER", 250,250);
				b_ctx.font = "14px Sans-Serif";
				b_ctx.fillText("Click to play again.",285,265);
				bricks_game.bricksLeft = 0;
				delete bricks_game.bricks;
				bricks_game.level = 1;
				bricks_game.getScores();	
			}
		}
			
		var paddle = {
			WIDTH : 100,
			HEIGHT : 10,
			x : 100,
			y : SCREEN_HEIGHT * 7/8,
			
			draw : function(){
				b_ctx.fillStyle = "white";
				b_ctx.fillRect(this.x,this.y, this.WIDTH, this.HEIGHT);
			},
			update : function(){
				if (mousex < 0){
					this.x = 0;
				}
				else if (mousex > SCREEN_WIDTH - this.WIDTH){
					this.x= SCREEN_WIDTH - this.WIDTH;
				}  
				else{	
					this.x= mousex;
				}
			}
		}
		var ball = {
			WIDTH : 10,
			HEIGHT : 10,
			
			x : 0,
			y : 250,
			dx : 2,
			dy: 2,
			
			draw : function(){
				b_ctx.fillStyle = 'white';
				b_ctx.fillRect(this.x,this.y,this.WIDTH,this.HEIGHT);
			},
			
			update : function(){
				//basic position change
				this.x += this.dx;
				this.y += this.dy;
				//check to see if paddle is hit
				if(this.y >= paddle.y && this.y <= paddle.y+paddle.HEIGHT){
					//paddle
					if(this.x + this.WIDTH >= paddle.x  && this.x <= paddle.x + paddle.WIDTH){
						this.dy = -1 * this.dy;
						this.y = paddle.y - this.HEIGHT;
						bricks_game.combo = 1;
					}
					//left of paddle
					if(this.x +this.WIDTH >=paddle.x && this.x <paddle.x + paddle.WIDTH/3){
						this.dx -=2; 
						return;
					}
					//right of paddle
					else if(this.x > paddle.x + 2*paddle.WIDTH/3 && this.x <= paddle.x+paddle.WIDTH){
						this.dx +=2; 
						return;
					}
				}
				//check walls
				if(this.x + this.WIDTH >= SCREEN_WIDTH || this.x <=0){
					this.dx = -1*this.dx;
				}
				if(this.y <= 0){
					this.dy = -1*this.dy;
				}
				if(this.y >= SCREEN_HEIGHT){
					bricks_game.death();
				}
			}
		}
//BRICK PSEUDOCLASS		
		function Brick(x,y){
			this.WIDTH = SCREEN_WIDTH/10-1;
			this.HEIGHT = 14;
			this.x = x;
			this.y = y;
			this.alive = true;
			
			Brick.prototype.hitCheck = function(){
			 //check for hit from bottom
			 //console.log('hitCheck executed');
			 if(this.y + this.HEIGHT >= ball.y && this.y < ball.y +ball.HEIGHT){
			 	if(this.x <= ball.x + ball.WIDTH && this.x + this.WIDTH >= ball.x){
			 		this.alive = false;
			 		bricks_game.score += (50*bricks_game.combo);
			 		bricks_game.combo++;
			 		bricks_game.bricksLeft--;
			 		console.log("bricks left = "+bricks_game.bricksLeft);
			 		ball.dy = -1 * ball.dy;	 				 		
			 	}
			 }
			}
		
			Brick.prototype.draw = function(){
				if(this.alive){
					b_ctx.fillStyle = "white";
					b_ctx.fillRect(this.x,this.y,this.WIDTH,this.HEIGHT);
				}
			}
		}
		
		function draw_bricks(brick_array){
			for(var i = 0; i < brick_array.length; i++){
				if(brick_array[i].alive){
					brick_array[i].draw();
				}
			}
		}
		
		function check_bricks(brick_array){
			for(var brick = 0; brick < brick_array.length; brick++){
				if(brick_array[brick].alive){
					brick_array[brick].hitCheck();
				}
			}
		}
		
		function create_bricks(){
			var brick_array = new Array();
			for(var bricky = 70; bricky < 70 + 15 * 10; bricky+=15){
				for(var brickx = 0; brickx < SCREEN_WIDTH; brickx+= SCREEN_WIDTH/10){
					brick_array.push(new Brick(brickx,bricky));
					bricks_game.bricksLeft++;
				}
			}
			return brick_array;
		}
		
		bricks_game.welcomeScreen();				
		</script>
	</body>
</html> 